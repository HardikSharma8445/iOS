workflows:
  ios-workflow:
    name: iOS HelloWorld Build
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        APP_NAME: "hello_world"
      groups:
        - ios  # this should include CERTIFICATE, CERTIFICATE_PASSWORD, PROVISIONING_PROFILE
    scripts:
      - name: Install dependencies
        script: |
          flutter pub get
      - name: Decode signing files
        script: |
          echo $CERTIFICATE | base64 --decode > certificate.p12
          echo $PROVISIONING_PROFILE | base64 --decode > profile.mobileprovision
      - name: Set up keychain and provisioning profile
        script: |
          KEYCHAIN_PATH="$HOME/Library/Keychains/login.keychain-db"
          security import certificate.p12 -k "$KEYCHAIN_PATH" -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          UUID=$(grep -a -o "UUID[^<]*" profile.mobileprovision | cut -d '>' -f2 | cut -d'<' -f1)
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
      - name: Build iOS app
        script: |
          flutter build ios --release

    artifacts:
      - build/ios/ipa/*.ipa

    publishing:
      email:
        recipients:
          - your-email@example.com
